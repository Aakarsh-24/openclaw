#!/bin/bash
# Quick Kubeconfig Setup Script
# Helps you set up the kubeconfig for prj-cus-78-cluster01

set -e

KUBECONFIG_DIR="$HOME/.kube"
KUBECONFIG_FILE="$KUBECONFIG_DIR/config"

echo "üìã Kubeconfig Setup for prj-cus-78-cluster01"
echo "============================================="
echo ""

# Create .kube directory if doesn't exist
if [ ! -d "$KUBECONFIG_DIR" ]; then
    echo "Creating $KUBECONFIG_DIR directory..."
    mkdir -p "$KUBECONFIG_DIR"
fi

# Check if kubeconfig already exists
if [ -f "$KUBECONFIG_FILE" ]; then
    echo "‚ö†Ô∏è  Warning: $KUBECONFIG_FILE already exists"
    echo ""
    read -p "Do you want to backup and replace it? (y/n): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        BACKUP_FILE="${KUBECONFIG_FILE}.backup.$(date +%Y%m%d-%H%M%S)"
        echo "Backing up to: $BACKUP_FILE"
        cp "$KUBECONFIG_FILE" "$BACKUP_FILE"
    else
        echo "Setup cancelled."
        exit 0
    fi
fi

# Create kubeconfig with admin credentials
echo "Creating kubeconfig at $KUBECONFIG_FILE..."

cat > "$KUBECONFIG_FILE" << 'EOF'
apiVersion: v1
clusters:
- cluster:
    certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUM2akNDQWRLZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJMk1ERXhOakExTVRneU1Wb1hEVE0yTURFeE5EQTFNak15TVZvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTVM0CmRnVFYxUXdJMTVhUldpa1hkdnFiVkxIY3Z2Z3N0VmtoWUJaVzkyN1RlRDJsaTRKeHU0YlpVb2pPNXNCYlJyaDMKOVdoZnd4ZVQwbVg1WVA3dG1QSW94NHc2VkZJTHkxY09NVVdyTjJMNkFvamZ0OUszUEFGbUxlMjlHN0ZKT21ZMgppRkdINWtrWE51a2VDdjNndER5TjN4dFZDSTdnUmZ2emVaSDJCMkZxenUwVGhOTEdDanZoMFR2d2xMaDBZMkJvCjhwbWtlUU5zTU81QmpHbjZHVzNxNm9udmdYalNYVjI1QXdYanpLdEZjd2xJTFNpUzFGMXhIRFpnNG9SQW1jcmwKb0xNZjZXSllLa1Y0UUlIT2lFa21Vc0FPL0hoVVNtOVQxQ1hoTDdmUXZjMjhDMXBNZmFoYVZ0Q0NqcjRnNUlFMwp2MnRueGlUbkdxZEJHNGlLWDhVQ0F3RUFBYU5GTUVNd0RnWURWUjBQQVFIL0JBUURBZ0trTUJJR0ExVWRFd0VCCi93UUlNQVlCQWY4Q0FRQXdIUVlEVlIwT0JCWUVGT0lMbGtiMzV4Y0pFVDNwVlQ1UmR1MERlR0h1TUEwR0NTcUcKU0liM0RRRUJDd1VBQTRJQkFRQ3owTjdvMFhBK0c5ckIrZEpDWmUvSDJPdVJKSDdoZEMvS0l4eFBxNTk3Nm5PRQpRTWUvZW14VEZpYURsZHc3em9SZlRyODZFN2s5bjE1YmhDUnJCK2E0WmtXR3JUanl6Y1Vaa2xudkIwQ1NzRFpzClE5VC82a1dzSXgrUUZZelRaKzRPQkwwcHNjTEt6UTFQTEoveFFqSFY5eDUyT2FOeTZhSHdEdW1LM1ZqMTQwZlMKbGRhMWRsemdjRklnak1CU3FsMXo4bG1tZFRTaHRMeU5zeE5zVEpSVEdXQ0wwNUpjOGw2aHNUTDcvREtkbExiOQpuVy9tV2ZpU1ZUWkFDUTFtOGJXTFI1TVFOQ1BJNWdTbStjaEZRdld3dzQzQ1FiSWRldzE2WUVlelNJUnJEejEvCnhYU0FnQk9JMGpDWlMzWEFCS2hDN09EUklzWjNjb3ZKRW9Na1VqRjQKLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=
    server: https://103.165.142.237:6443
  name: prj-cus-78-clawdbot-cluster
contexts:
- context:
    cluster: prj-cus-78-clawdbot-cluster
    user: prj-cus-78-clawdbot-cluster-admin
  name: prj-cus-78-clawdbot-cluster-admin@prj-cus-78-clawdbot-cluster
current-context: prj-cus-78-clawdbot-cluster-admin@prj-cus-78-clawdbot-cluster
kind: Config
preferences: {}
users:
- name: prj-cus-78-clawdbot-cluster-admin
  user:
    client-certificate-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURFekNDQWZ1Z0F3SUJBZ0lJT0RCdkF2RytGMmN3RFFZSktvWklodmNOQVFFTEJRQXdGVEVUTUJFR0ExVUUKQXhNS2EzVmlaWEp1WlhSbGN6QWVGdzB5TmpBeE1UWXdOVEU0TWpGYUZ3MHlOekF4TVRZd05USXpNakphTURReApGekFWQmdOVkJBb1REbk41YzNSbGJUcHRZWE4wWlhKek1Sa3dGd1lEVlFRREV4QnJkV0psY201bGRHVnpMV0ZrCmJXbHVNSUlCSWpBTkJna3Foa2lHOXcwQkFRRUZBQU9DQVE4QU1JSUJDZ0tDQVFFQXRWRlhvZUhvM1NoL0Vka2EKQlNtWkVwcU5HcjlDeUIySWNXaExDM1VZWE8xTHNKQmpMOVVoZVVncUl4RjdxdFVYWW5aOHVxNWJkQ2lEMWRpZQo3eWdRYnZGcnMvN0xtWUdSQmdJKytNUk92ek1ySUVzUGphcG5RV3pQSW5WRzNQV1J3SUFVQ0pMQVdYS0g5RTBOCkpnZ0kyeEx5WWpyOVlIU2VNZVI4ZEJrd042MTlLd01nTURTYU9iQ1c5K1U0RlYvaFFpaDA1aU5kcDczZW5HNkkKMGVnaWFxRTFIa1c5TlNDaE05MjlIeGY1VmE4T1lQOWVtVkNUa3hWeHdsTXdQQzhTNmdwaTZLL1J5RE9XNWdGVApkaXdlV3daNXRXT2g1UjRFNHF2cmZjZ2U1RmFoeWdBb3JxbTI4NkkrRUFvQ2dqZjVOa3RzNGVNbzhhUUdvVHJoCnFGS0V0d0lEQVFBQm8wZ3dSakFPQmdOVkhROEJBZjhFQkFNQ0JhQXdFd1lEVlIwbEJBd3dDZ1lJS3dZQkJRVUgKQXdJd0h3WURWUjBqQkJnd0ZvQVU0Z3VXUnZmbkZ3a1JQZWxWUGxGMjdRTjRZZTR3RFFZSktvWklodmNOQVFFTApCUUFEZ2dFQkFISVhPMndIeXY4R3JjOXVqQmgrYXBCY3lLWkJuY0VpRUsvRFpZYkN3RjZhMzJVUTkwYWRESnQ3CjhtbmhLSUNXZWFkeFdudk5rRlRLLzVRS29QZjRIR1FoZjd0cE1LUlJHU21yRzdaeVpnclFBMnVEM0hwNDk4VUQKZG43TEFuYVNsQ2o5V3drVzIyaSs1MWFjbExEUG5CR0daREg2OERpQVB5ejlsanQrNHZxQWoxV2lBNEVrclF2YQo4OTFnc3VCeHI2L1JVSkVEM1V1ejN5UktIYUxrd0YrSFJOTU9TUVJZN01LcUJLekZmUTEvZG51OUc2dTVXY2hPCmorWnBUejBtb0RmOHFJQlRhTkNjR2t1U1FUbkxUUEV4ejczSnRTN3ZPM3VoZ3AyRkhySEVvNGU4K0FYV3ZnaFQKS0RNajB2K1pZdXdwcTFvNG5qMGJZMUN6MW5rMVhJOD0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=
    client-key-data: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQkFBS0NBUUVBdFZGWG9lSG8zU2gvRWRrYUJTbVpFcHFOR3I5Q3lCMkljV2hMQzNVWVhPMUxzSkJqCkw5VWhlVWdxSXhGN3F0VVhZblo4dXE1YmRDaUQxZGllN3lnUWJ2RnJzLzdMbVlHUkJnSSsrTVJPdnpNcklFc1AKamFwblFXelBJblZHM1BXUndJQVVDSkxBV1hLSDlFME5KZ2dJMnhMeVlqcjlZSFNlTWVSOGRCa3dONjE5S3dNZwpNRFNhT2JDVzkrVTRGVi9oUWloMDVpTmRwNzNlbkc2STBlZ2lhcUUxSGtXOU5TQ2hNOTI5SHhmNVZhOE9ZUDllCm1WQ1RreFZ4d2xNd1BDOFM2Z3BpNksvUnlET1c1Z0ZUZGl3ZVd3WjV0V09oNVI0RTRxdnJmY2dlNUZhaHlnQW8KcnFtMjg2SStFQW9DZ2pmNU5rdHM0ZU1vOGFRR29UcmhxRktFdHdJREFRQUJBb0lCQVFDMUlTNDJ4RlA0NHFTVgo4dGhBZ2Y2dGpBRWIwQ2JwZkQ4NmMySk1ic3hJd0xEVkVGaFZoMGNxUGtJQnlFeFBLeEp5UlVWeXhBME9MQThQClNKZjA5NFA3SUdka1owdUM3T0V3TEh3MXpQMlJtWThpY25sMkh0MkppU1lmR1NNU1JxczByMzNUMXE0YWJRU04KczQ5SUI4eTQ5T04zNTlBSVZGZFlKaFdCY1V3dXdRMXdOVmNPckpUdHRMWHR1d1V2VGlLVTFJZVRHZ2lkdDM3dAo4dHJUWDlsUEN0emRkUkh5WVc0cDY5Ym9NcVpUN1N3dTdkd3lHNm9DTFRhSVVNVll1NzBETTBsSGJvWFJkY0NuCjZacUFoZEIwRTk2L3h4YUJUVGxEMXIyeFI2amZ1SDBHbzFRMFpialNORnMxYmdSa2I2M3ErQk53QVNlVkdMNmIKRW9XMVRMZVpBb0dCQU55SUUyeXAzWlY5Z2ZxeXp1cjdiV29HaVlvUURqaHEveW5DV1hnZ0ZEd2V5L3M2dnFFMApMNmJsUVhKTFA4Q1FzVFFvS2RMUjJ2UEE3VHh1VklVZHVVTm9TUFNpUk9hcGYyampjNSttWUQ2RlZUQVlMVWRYCmxWNGRBeHB0SGpjbjRtU05wT1l6Z2IvZCt1RXkyNFZHUWtJMVNsZHVodFEwdGdhc1BCSzR3R3FEQW9HQkFOSjYKdUdYSSt0SUFuZUhCMVFBWWQ4STdTTGZmSE9hTWxuMnVNc3V6aXF4eXpVRGxDcElCWDdhK2s1ZTQ3cDhiTXVuLwozSmQvanZKVTZUVWhhaUNVc3F1d2NWbldXY2xpNUhTSFdESmt6STRKWkg2d2RJMk1mYVpUZXUyR0YwazFsWlEyCi9vQmNvQXhMUnpoSjBySmphdmhXZEhROUZvamlVM1hQQmIzNFR2YTlBb0dCQUxnMDJiVE1kcEFsMCtwcWJUZ08KYUNoRjZhRHZKRkd2M2c4dGpib3ZZWGVPYWVnaCs1Vi9sOFlhZlA1UktLRmF1d25MK3BOa1F6V1VFeFdGT3dndAorYy82VGVZNW5ML25HTXV1SWFoYk9zMCtaaGZVT2czN2RJSzJUUjlId2hOa04xQ3lsK2pKWVRtNDI1UTcvTzFuCjhIU0pPdDJwTHVvV1ZXMWhkSlJXeWpLdEFvR0FHWVhPRkhHaGtKT0lrWmFhaUk5dS9qdUlIdHZNT2x5ejV2dVgKcDBIWFFBQVB5WjI4Z1dYdlFFNnR3UWtvemx4UytUTVFnY0p6Q0FtcDJjcDZmd2JvLzQ2K3dBRVJGQzJNdkdDcApIanRBM3J4ZTFrbjVhQ3l3RTlvdG50M1N0d3JyWDNTbnVkTUJpVndiZjhUYjZzdkpiZUcxNzE1MC9CWk52b3hqCkN0MHdYaFVDZ1lCS0NURVl6SlB1SXZLTVBaSktxdjYwL1BJZVE1RzVBTmNCSHBYa3ZkUWxhUG1xSVJwWmtQUHcKNEFsdDVvditWeHkxN0p3dm1BeFJ5ZG5CYkdpMDdpVmc1dVN2VUxaYisyc01SaWp0Rkx2MU82RkUzajhDaDErawpxTUcwRjJoVkIrNW5yNG9jR1NGZGdUZ2JMSDEyK1d5VDFUN3MxZ3U2VkxDZmVOalNRTjZORmc9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo=
EOF

# Set proper permissions
chmod 600 "$KUBECONFIG_FILE"

echo ""
echo "‚úÖ Kubeconfig created successfully!"
echo ""
echo "Testing connection..."
if kubectl cluster-info &>/dev/null; then
    echo "‚úÖ Successfully connected to cluster!"
    kubectl cluster-info
    echo ""
    echo "Current context: $(kubectl config current-context)"
else
    echo "‚ö†Ô∏è  Kubeconfig created but connection test failed."
    echo "You may need to:"
    echo "  1. Check network connectivity to 103.165.142.57:6443"
    echo "  2. Verify credentials are correct"
fi

echo ""
echo "Next steps:"
echo "  1. Verify connection: kubectl get nodes"
echo "  2. Continue with deployment: ./deploy.sh"
